@model HGO.ASPNetCore.FileManager.ViewComponentsModel.FileManagerModel
@using HGO.ASPNetCore.FileManager.Enums
@using HGO.ASPNetCore.FileManager.Helpers



<img id="loadingScripts" src="/hgofilemanager/images/loading.gif" alt="loading...">
<div id="@Model.Id" style="display: none;">
</div>

<script type="text/javascript">
  class HgoFileManager {
    thisId;
    apiUrl;
    // config;

    menuButtonContinerDiv;
    menuInputContinerDiv;
    jsSelectContinerDiv;
    breadcrumbContinerDiv;

    jsTree;
    jsSelect;
    contextMenu;
    lazyLoader;

    clipboard = [];
    browseHistory = [];

    backButton;
    pasteButton;

    static instances = [];

    constructor() {
        this.thisId = "@Model.Id";
        this.apiUrl = "@Model.ApiEndPoint";
        // this.config = config;

        this.#initExplorer();
        this.lazyLoader = lozad();
        this.getFolderContent();

        HgoFileManager.instances.push(this);
    }

    destroy() {
        let i = HgoFileManager.instances.indexOf(this);
        HgoFileManager.instances.splice(i, 1);
    }

    static selectById(id) {
        if (id && HgoFileManager.instances && HgoFileManager.instances.length > 0) {
            let instance = HgoFileManager.instances.filter(function (el) {
                return el && el.thisId == "hgo_fm_" + id;
            });
            if (instance && instance.length > 0)
                return instance[0];
        }
    }

    #initMenu() {

        let menuContinerDiv = document.createElement('div');
        menuContinerDiv.classList.add('hgo-fm-menu');
        this.#fileManager().appendChild(menuContinerDiv);

        this.menuButtonContinerDiv = document.createElement('div');
        this.menuButtonContinerDiv.classList.add('button-continer');
        menuContinerDiv.appendChild(this.menuButtonContinerDiv);

        this.menuInputContinerDiv = document.createElement('div');
        this.menuInputContinerDiv.classList.add('input-continer');
        menuContinerDiv.appendChild(this.menuInputContinerDiv);

        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Browse)) {

            this.backButton = this.addButtonToMenu('<i class="fa-solid fa-rotate-left"></i>', (e) => this.goPreviousPath());
            this.backButton.setAttribute('title', '@Model.Config.Language.Back');
            this.backButton.setAttribute('disabled', 'disabled');

            this.addButtonToMenu('<i class="fa-solid fa-turn-up"></i>', (e) => this.goUpFolder()).setAttribute('title', '@Model.Config.Language.Up');

            this.addButtonToMenu();

        }

        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Copy)) {

            this.addButtonToMenu('<i class="fa-solid fa-copy"></i>', (e) => this.copyItems()).setAttribute('title', '@Model.Config.Language.Copy');

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Cut)) {

            this.addButtonToMenu('<i class="fa-solid fa-scissors"></i>', (e) => this.cutItems()).setAttribute('title', '@Model.Config.Language.Cut');

        }
        if (!(@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Copy) && @Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Cut))) {
            this.pasteButton = this.addButtonToMenu('<i class="fa-solid fa-paste"></i>', (e) => this.pasteItems());
            this.pasteButton.setAttribute('title', 'Paste');
            this.pasteButton.setAttribute('disabled', 'disabled');

            this.addButtonToMenu();
        }

        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Rename)) {

            this.addButtonToMenu('<i class="fa-solid fa-i-cursor"></i>', (e) => this.renameSelectedItems()).setAttribute('title', '@Model.Config.Language.Rename');

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.GetFileContent)) {

            this.addButtonToMenu('<i class="fa-solid fa-file-pen"></i>', (e) => this.getFileContent()).setAttribute('title', '@Model.Config.Language.Edit');

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Delete)) {

            this.addButtonToMenu('<i class="fa-solid fa-trash"></i>', (e) => this.deleteSelectedItems()).setAttribute('title', '@Model.Config.Language.Delete');

        }
        if (!(@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Rename) && @Model.Config.DisabledFunctions.ContainsToStringToLower(Command.GetFileContent) && @Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Delete))) {

            this.addButtonToMenu();

        }

        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.CreateNewFolder)) {

            this.addButtonToMenu('<i class="fa-solid fa-folder-plus"></i>', (e) => this.createNewFolder()).setAttribute('title', '@Model.Config.Language.CreateNewFolder');

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.CreateNewFile)) {

            this.addButtonToMenu('<i class="fa-solid fa-file-circle-plus"></i>', (e) => this.createNewFile()).setAttribute('title', '@Model.Config.Language.CreateNewFile');

        }
        if (!(@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.CreateNewFolder) && @Model.Config.DisabledFunctions.ContainsToStringToLower(Command.CreateNewFile))) {

            this.addButtonToMenu();

        }

        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.View)) {

            this.addButtonToMenu('<i class="fa-solid fa-eye"></i>', (e) => this.viewFile()).setAttribute('title', '@Model.Config.Language.View');

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Download)) {

            this.addButtonToMenu('<i class="fa-solid fa-cloud-arrow-down"></i>', (e) => this.downloadFile()).setAttribute('title', '@Model.Config.Language.Download');

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Upload)) {

            this.addButtonToMenu('<i class="fa-solid fa-cloud-arrow-up"></i>', (e) => this.showUploadPanel()).setAttribute('title', '@Model.Config.Language.Upload');

        }
        if (!(@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Download) && @Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Upload) && @Model.Config.DisabledFunctions.ContainsToStringToLower(Command.View))) {

            this.addButtonToMenu();

        }

        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Zip)) {

            this.addButtonToMenu('<i class="fa-solid fa-file-zipper"></i>', (e) => this.zipSelectedItems()).setAttribute('title', '@Model.Config.Language.Zip');

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Unzip)) {

            this.addButtonToMenu('<i class="fa-solid fa-square-arrow-up-right"></i>', (e) => this.extractSelectedItems()).setAttribute('title', '@Model.Config.Language.Unzip');

        }
        if (!(@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Unzip) && @Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Zip))) {

            this.addButtonToMenu();

        }

        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.ToggleView)) {

            this.addButtonToMenu('<i class="fa-solid fa-list-ul"></i>', (e) => this.toggleFilesListView()).setAttribute('title', '@Model.Config.Language.ToggleView');

        }

        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Search)) {

            this.addInputToMenu('@Model.Config.Language.Search', (e) => {
                if (e.keyCode == 13) this.search(e.currentTarget.value);
            }, 'search-box');

        }

        if (@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.MenuBar)) {

            menuContinerDiv.style.display = 'none';

        }
    }

    #initContextMenu() {
        // let disabledFunctions = (typeof this.config.disabledFunctions != "undefined" ? this.config.disabledFunctions.join(',') : '').toLowerCase();
        let self = this;
        let menuItems = [];

        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Browse)) {

            menuItems.push({
                text: '<i class="fa-solid fa-turn-up"></i> @Model.Config.Language.Up',
                onclick: function (e) {
                    self.goUpFolder();
                }
            });

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Reload)) {

            menuItems.push({
                text: '<i class="fa-solid fa-repeat"></i> @Model.Config.Language.Reload',
                onclick: function (e) {
                    self.getFolderContent();
                }
            });

        }
        if (!(@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Reload) && @Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Reload))) {

            menuItems.push(null);

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Copy)) {

            menuItems.push({
                text: '<i class="fa-solid fa-copy"></i> @Model.Config.Language.Copy',
                onclick: function (e) {
                    self.copyItems();
                }
            });

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Cut)) {

            menuItems.push({
                text: '<i class="fa-solid fa-scissors"></i> @Model.Config.Language.Cut',
                onclick: function (e) {
                    self.cutItems();
                }
            });

        }
        if (!(@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Copy) && @Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Cut))) {

            menuItems.push({
                text: '<i class="fa-solid fa-paste"></i> @Model.Config.Language.Paste',
                onclick: function (e) {
                    self.pasteItems();
                },
                disabled: true
            });
            menuItems.push(null);

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.CreateNewFolder)) {

            menuItems.push({
                text: '<i class="fa-solid fa-folder-plus"></i> @Model.Config.Language.CreateNewFolder',
                onclick: function (e) {
                    self.createNewFolder();
                }
            });

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.CreateNewFile)) {

            menuItems.push({
                text: '<i class="fa-solid fa-file-circle-plus"></i> @Model.Config.Language.CreateNewFile',
                onclick: function (e) {
                    self.createNewFile();
                }
            });

        }
        if (!(@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.CreateNewFolder) && @Model.Config.DisabledFunctions.ContainsToStringToLower(Command.CreateNewFile))) {

            menuItems.push(null);

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Rename)) {

            menuItems.push({
                text: '<i class="fa-solid fa-i-cursor"></i> @Model.Config.Language.Rename',
                onclick: function (e) {
                    self.renameSelectedItems();
                }
            });

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.GetFileContent)) {

            menuItems.push({
                text: '<i class="fa-solid fa-file-pen"></i> @Model.Config.Language.Edit',
                onclick: function (e) {
                    self.getFileContent();
                }
            });

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Delete)) {

            menuItems.push({
                text: '<i class="fa-solid fa-trash"></i> @Model.Config.Language.Delete',
                onclick: function (e) {
                    self.deleteSelectedItems();
                }
            });

        }
        if (!(@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Rename) && @Model.Config.DisabledFunctions.ContainsToStringToLower(Command.GetFileContent) && @Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Delete))) {

            menuItems.push(null);

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Zip)) {

            menuItems.push({
                text: '<i class="fa-solid fa-file-zipper"></i> @Model.Config.Language.Zip',
                onclick: function (e) {
                    self.zipSelectedItems();
                }
            });

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Unzip)) {

            menuItems.push({
                text: '<i class="fa-solid fa-square-arrow-up-right"></i> @Model.Config.Language.Unzip',
                onclick: function (e) {
                    self.extractSelectedItems();
                }
            });

        }
        if (!(@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Unzip) && @Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Unzip))) {

            menuItems.push(null);

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.View)) {

            menuItems.push({
                text: '<i class="fa-solid fa-eye"></i> @Model.Config.Language.View',
                onclick: function (e) {
                    self.viewFile();
                }
            });

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Download)) {

            menuItems.push({
                text: '<i class="fa-solid fa-cloud-arrow-down"></i> @Model.Config.Language.Download',
                onclick: function (e) {
                    self.downloadFile();
                }
            });

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Upload)) {

            menuItems.push({
                text: '<i class="fa-solid fa-cloud-arrow-up"></i> @Model.Config.Language.Upload',
                onclick: function (e) {
                    self.showUploadPanel();
                }
            });

        }


        this.contextMenu = new ContextMenu(this.jsSelectContinerDiv, menuItems);


        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.ContextMenu)) {

            this.contextMenu.install();

        }
    }

    #initExplorer() {
        let self = this;
        // let disabledFunctions = (typeof this.config.disabledFunctions != "undefined" ? this.config.disabledFunctions.join(',') : '').toLowerCase();

        this.#fileManager().classList.add('hgo-fm-wrapper');

        //init top menu------------------------------------------------
        this.#initMenu();

        //create elements----------------------------------------------
        let wrapper = document.createElement('div');
        wrapper.classList.add('hgo-fm-content-wrapper');
        this.#fileManager().appendChild(wrapper);

        let jsTreeDiv = document.createElement('div');
        jsTreeDiv.classList.add('hgo-fm-tree');
        wrapper.appendChild(jsTreeDiv);

        this.jsSelectContinerDiv = document.createElement('div');
        this.jsSelectContinerDiv.classList.add('hgo-fm-fsitems');
        if (Cookies.get('hgo-fm-current-view-' + this.thisId))
            this.jsSelectContinerDiv.classList.add(Cookies.get('hgo-fm-current-view-' + this.thisId));
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Browse)) {

            this.jsSelectContinerDiv.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                this.goUpFolder();
            });

        }
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Upload)) {

            this.jsSelectContinerDiv.addEventListener('dragover', (e) => {
                if (e.dataTransfer.types.length > 0 && e.dataTransfer.types[0] == "Files" &&
                    e.dataTransfer.items.length > 0) {
                    e.stopPropagation();
                    this.showUploadPanel();
                }
            });

        }

        wrapper.appendChild(this.jsSelectContinerDiv);

        this.breadcrumbContinerDiv = document.createElement('div');
        this.breadcrumbContinerDiv.classList.add('hgo-fm-breadcrumb');
        this.#fileManager().appendChild(this.breadcrumbContinerDiv);

        let loadingPanelDiv = document.createElement('div');
        loadingPanelDiv.classList.add('loadingPanel');
        loadingPanelDiv.style.display = 'none';
        this.#fileManager().appendChild(loadingPanelDiv);

        let loaderDiv = document.createElement('div');
        loaderDiv.classList.add('loader');
        loadingPanelDiv.appendChild(loaderDiv);

        //init context menu--------------------------------------------
        this.#initContextMenu();

        //init JsTree--------------------------------------------------
        $(jsTreeDiv).jstree({
            "checkbox": {
                "keep_selected_style": false
            },
            "plugins": []
        }).on("select_node.jstree", (
            function (evt, data) {
                if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Browse)) {
                    if (data.event.type === 'click') {
                        if (data.node.parent === "#") {
                            //Click on root node
                            self.goUpFolder();
                        } else {
                            //Click on child nodes
                            self.getFolderContent(self.getCurrentPath() + "\\" + data.node.text);
                        }
                    }
                } else {
                    null
                }
            }
        ));
        this.jsTree = $(jsTreeDiv).jstree(true);
        if (@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.FoldersTree)) {

            jsTreeDiv.style.display = 'none';

        }

        //init ViSelect------------------------------------------------
        this.jsSelect = new SelectionArea({
            selectables: ['#' + this.thisId + ' .hgo-fm-fsitems > .fsitem'],
            boundaries: [this.jsSelectContinerDiv],
        }).on('beforestart', ({
            store,
            event
        }) => {
            let contextMenu = $('#' + this.thisId + ' .hgo-fm-fsitems .context');
            if (!event.ctrlKey && !event.metaKey && contextMenu.length === 0) {

                for (const el of store.stored) {
                    el.classList.remove('selected');
                }

                this.jsSelect.clearSelection();
            }
        }).on('move', ({
            store: {
                changed: {
                    added,
                    removed
                }
            }
        }) => {
            for (const el of added) {
                el.classList.add('selected');
            }

            for (const el of removed) {
                el.classList.remove('selected');
            }

        }).on('beforedrag', ({
            store,
            event
        }) => {
            if (!event.ctrlKey && !event.metaKey) {
                this.jsSelect.clearSelection();
            }
        });

        //init SplitJS-------------------------------------------------
        if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.FoldersTree)) {

            let sizes;

            if (window.innerWidth > 1024) { // Large screens
                sizes = [20, 80];
            } else if (window.innerWidth > 600) { // Medium screens
                sizes = [30, 70];
            } else { // Small screens
                sizes = [45, 55];
            }

            Split([jsTreeDiv, this.jsSelectContinerDiv], {
                sizes: sizes,
                gutterSize: 5, // Optional: adjust gutter size if needed
            });


        }
    }

    #WaitingPanel() {
        let loadingPanel = this.#fileManager().querySelector('.loadingPanel');
        if (loadingPanel.style.display == 'none') {
            loadingPanel.style.display = 'block';
        } else {
            loadingPanel.style.display = 'none';
        }
    }

    #reloadBreadcrumb() {
        // let disabledFunctions = (typeof this.config.disabledFunctions != "undefined" ? this.config.disabledFunctions.join(',') : '').toLowerCase();
        if (@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Breadcrumb)) {

            this.breadcrumbContinerDiv.style.display = 'none';
            return;

        }

        this.breadcrumbContinerDiv.style.display = 'initial';

        let splitedDirs = this.getCurrentPath().split('\\').filter(i => i);
        if (splitedDirs && splitedDirs.length > 0) {
            let currentDir = '';
            let continerUl = document.createElement('ul');
            for (let i = 0; i < splitedDirs.length; i++) {

                let dir = splitedDirs[i];
                currentDir += dir + "\\";
                let li = document.createElement('li');

                if (i < splitedDirs.length - 1) {

                    let btn = document.createElement('button');
                    btn.innerText = dir;
                    btn.setAttribute('path', currentDir);
                    if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Browse)) {

                        btn.addEventListener('click', (e) => {
                            this.getFolderContent(e.currentTarget.getAttribute('path'));
                        });

                    }

                    li.appendChild(btn);

                } else {
                    li.innerText = dir;
                }

                continerUl.appendChild(li);
            }
            this.breadcrumbContinerDiv.innerHTML = '';
            this.breadcrumbContinerDiv.appendChild(continerUl);
        }
    }

    #fillFolderContent(data) {
        // let disabledFunctions = (typeof this.config.disabledFunctions != "undefined" ? this.config.disabledFunctions.join(',') : '').toLowerCase();

        if (data.Error) {
            this.showToastify(data.Error);
            return;
        }

        if (!data.Files || !data.Folders || !data.CurrentPath) {
            return;
        }

        let currentPath = data.CurrentPath.replace(/\\+$/, '') + "\\";
        this.#setCurrentPath(currentPath);

        let self = this;

        let selectDiv = this.jsSelectContinerDiv;
        selectDiv.innerHTML = '';

        let jsTreeNodes = [];

        $.each(data.Folders, function (idx, folder) {

            jsTreeNodes.push({
                'text': folder.FolderName,
                'state': {
                    'opened': false,
                    'selected': false
                }
            });

            let fsItemDiv = document.createElement('div');
            fsItemDiv.setAttribute('title', '@Model.Config.Language.FolderName: ' + folder.FolderName + '\n' + '@Model.Config.Language.CreateDate: ' + folder.CreateDate + '\n' + '@Model.Config.Language.ModifiedDate: ' + folder.ModifiedDate);
            fsItemDiv.setAttribute('path', folder.VirtualPath);
            fsItemDiv.setAttribute('item-type', 'folder');
            fsItemDiv.classList.add('fsitem');
            if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.Browse)) {

                fsItemDiv.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    let path = e.currentTarget.getAttribute('path');
                    self.getFolderContent(path);
                });

            }


            let fsItemImg = document.createElement('img');
            fsItemImg.classList.add('lozad');
            fsItemImg.src = '/hgofilemanager/images/loading.gif';
            fsItemImg.setAttribute('data-src', '/hgofilemanager/images/folder.png');
            fsItemDiv.appendChild(fsItemImg);

            let fsItemSpan = document.createElement('span');
            fsItemSpan.innerText = folder.FolderName;
            fsItemDiv.appendChild(fsItemSpan);

            selectDiv.appendChild(fsItemDiv);
        });

        data.Files.forEach((file) => {

            let fsItemDiv = document.createElement('div');
            fsItemDiv.setAttribute('title', '@Model.Config.Language.FileName: ' + file.FileName + '\n' + '@Model.Config.Language.Size: ' + file.FileSize + '\n' + '@Model.Config.Language.CreateDate: ' + file.CreateDate + '\n' + '@Model.Config.Language.ModifiedDate: ' + file.ModifiedDate);
            fsItemDiv.setAttribute('path', file.VirtualPath);
            fsItemDiv.setAttribute('item-type', 'file');
            fsItemDiv.classList.add('fsitem');
            if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.View)) {

                fsItemDiv.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    self.viewFile();
                });

            }

            let fsItemImg = document.createElement('img');
            fsItemImg.classList.add('lozad');
            fsItemImg.src = '/hgofilemanager/images/loading.gif';
            if (!@Model.Config.DisabledFunctions.ContainsToStringToLower(Command.FilePreview)) {

                fsItemImg.setAttribute('data-src', '@Model.ApiEndPoint' + `?id=@Model.Id&command=@Command.FilePreview&parameters=${file.VirtualPath}`);

            } else {

                fsItemImg.setAttribute('data-src', '/hgofilemanager/images/file.png');

            }

            fsItemDiv.appendChild(fsItemImg);

            let fsItemSpan = document.createElement('span');
            fsItemSpan.innerText = file.FileName;
            fsItemDiv.appendChild(fsItemSpan);

            let fsItemSizeSpan = document.createElement('span');
            fsItemSizeSpan.innerText = file.FileSize;
            fsItemSizeSpan.classList.add('file-size');
            fsItemSpan.appendChild(fsItemSizeSpan);

            selectDiv.appendChild(fsItemDiv);

        });

        this.jsTree.settings.core.data = [

            {
                'text': currentPath,
                'state': {
                    'opened': true,
                    'selected': false
                },
                'children': jsTreeNodes
            }
        ];
        this.jsTree.deselect_all(true);
        this.jsTree.refresh();
        this.#reloadBreadcrumb(currentPath);
        this.lazyLoader.observe();;
    }

    #checkIfAnyItemSelected(itemtype) {
        let selectedItems = this.getSelectedItemsPath(itemtype);
        if (!selectedItems) {
            this.showToastify('@Model.Config.Language.NoItemsSelectedMessage');
            return false;
        }
        return selectedItems;
    }

    #fileManager() {
        return document.getElementById(this.thisId);
    }

    #setCurrentPath(path) {
        if (path)
            Cookies.set('hgo-fm-current-path-' + this.thisId, path, {
                expires: 365
            });
    }

    getCurrentPath = function () {
        let path = Cookies.get('hgo-fm-current-path-' + this.thisId);
        if (path)
            return path.replace(/\\+$/, '') + "\\";
        return "";
    }

    showToastify = function (text, type = 'error') {
        let bgColor = 'linear-gradient(to right, #b6ff8a, #238f00);';
        if (type === 'error') {
            bgColor = "linear-gradient(to right, #ff8a8a, #ff6565)";
        }

        Toastify({
            text: text,
            duration: 3000,
            selector: this.thisId,
            close: true,
            gravity: "bottom",
            position: "right",
            stopOnFocus: true,
            style: {
                background: bgColor,
                color: "#fff",
                position: "absolute"
            }
        }).showToast();
    }

    getSelectedItemsPath = function (itemtype) {
        let selectedItems = this.jsSelect.getSelection();
        if (selectedItems.length == 0) {
            return undefined;
        }

        let paths = [];
        for (let i = 0; i < selectedItems.length; i++) {
            if (!itemtype) {
                paths.push(selectedItems[i].getAttribute('path'));
            } else {
                if (selectedItems[i].getAttribute('item-type') == itemtype) {
                    paths.push(selectedItems[i].getAttribute('path'));
                }
            }
        }
        if (paths.length == 0) {
            return undefined;
        }

        return paths;
    }

    getAllItemsPath = function () {
        let allItems = $(this.jsSelectContinerDiv).find('.fsitem').map(function () {
            return $(this).attr("path");
        }).get();

        if (allItems.length > 0)
            return allItems;

        return undefined;
    }

    addButtonToMenu(innHtml, clickEventHandler, className) {
        if (innHtml) {
            let btn = document.createElement("button");
            btn.innerHTML = innHtml;
            if (clickEventHandler) btn.addEventListener('click', (e) => clickEventHandler(e));
            if (className) btn.classList.add(className);
            this.menuButtonContinerDiv.appendChild(btn);
            return btn;
        }
        let divider = document.createElement("hr");
        this.menuButtonContinerDiv.appendChild(divider);
        return divider;
    }

    addInputToMenu(placeholder, keydownEventHandler, className) {
        let input = document.createElement("input");
        input.setAttribute('placeholder', placeholder);
        if (keydownEventHandler) input.addEventListener('keydown', (e) => keydownEventHandler(e));
        if (className) input.classList.add(className);
        this.menuInputContinerDiv.appendChild(input);
    }

    getFolderContent = function (folder, addToHistory = true) {
        let self = this;

        if (!folder) {
            folder = this.getCurrentPath();
        } else {
            if (addToHistory === true) {
                if (this.browseHistory[this.browseHistory.length - 1] != this.getCurrentPath()) {
                    this.browseHistory.push(this.getCurrentPath());
                    if (this.backButton)
                        this.backButton.removeAttribute('disabled');
                }
            }
        }

        folder = folder.replace(/\\+$/, '') + "\\";
        this.#WaitingPanel();
        $.post(this.apiUrl, {
            id: this.thisId,
            command: "@Command.GetFolderContent",
            parameters: folder
        }, function (data) {
            self.#WaitingPanel();
            self.#fillFolderContent(data);
        }, 'json');
    }

    goUpFolder = function () {
        let currentPath = this.getCurrentPath().replace(/\\+$/, '');
        if (currentPath) {
            this.getFolderContent(currentPath.substring(0, currentPath.lastIndexOf('\\')) + "\\");
        }
    }

    search = function (query) {
        let self = this;
        this.#WaitingPanel();
        $.post(this.apiUrl, {
            id: this.thisId,
            command: "@Command.Search",
            parameters: JSON.stringify({
                Path: this.getCurrentPath(),
                Query: query
            })
        }, function (data) {
            self.#WaitingPanel();
            self.#fillFolderContent(data);
        }, 'json');
    }

    createNewFolder = function () {
        let newFolderName = prompt("@Model.Config.Language.EnterNewFolderNameMessage", "@Model.Config.Language.NewFolderPlaceHolder");
        if (!newFolderName) {
            return;
        }

        let self = this;
        this.#WaitingPanel();
        $.post(this.apiUrl, {
            id: this.thisId,
            command: "@Command.CreateNewFolder",
            parameters: JSON.stringify({
                Path: this.getCurrentPath(),
                FolderName: newFolderName
            })
        }, function (data) {
            self.#WaitingPanel();
            self.#fillFolderContent(data);
        }, 'json');
    }

    createNewFile = function () {
        let newFileName = prompt("@Model.Config.Language.EnterNewFileNameMessage", "@Model.Config.Language.NewFilePlaceHolder");
        if (!newFileName) {
            return;
        }

        let self = this;
        this.#WaitingPanel();
        $.post(this.apiUrl, {
            id: this.thisId,
            command: "@Command.CreateNewFile",
            parameters: JSON.stringify({
                Path: this.getCurrentPath(),
                FileName: newFileName
            })
        }, function (data) {
            self.#WaitingPanel();
            self.#fillFolderContent(data);
        }, 'json');
    }

    deleteSelectedItems = function () {
        let selectedItems = this.#checkIfAnyItemSelected();
        if (selectedItems === false) {
            return;
        }

        if (confirm("@Model.Config.Language.DeleteConfirmationMessage")) {
            let self = this;
            this.#WaitingPanel();
            $.post(this.apiUrl, {
                id: this.thisId,
                command: "@Command.Delete",
                parameters: JSON.stringify({
                    Path: this.getCurrentPath(),
                    Items: selectedItems
                })
            }, function (data) {
                self.#WaitingPanel();
                self.#fillFolderContent(data);
            }, 'json');
        }
    }

    renameSelectedItems = function () {
        let selectedItems = this.#checkIfAnyItemSelected();
        if (selectedItems === false) {
            return;
        }

        let firstItemName = selectedItems[0].split("\\").pop();
        let newName = prompt("@Model.Config.Language.RenameMessage", firstItemName);
        if (!newName) {
            return;
        }

        let currentPath = this.getCurrentPath();

        //check if already exist
        let allItems = this.getAllItemsPath();
        if (allItems)
            for (let i = 0; i < allItems.length; i++) {
                let element = allItems[i];
                if (element.toLowerCase() === (currentPath + newName).toLowerCase()) {
                    if (confirm("'" + newName + "' @Model.Config.Language.ItemAlreadyExistMessage")) {
                        break;
                    } else {
                        return;
                    }
                }
            }

        let self = this;
        this.#WaitingPanel();
        $.post(this.apiUrl, {
            id: this.thisId,
            command: "@Command.Rename",
            parameters: JSON.stringify({
                Path: currentPath,
                Items: selectedItems,
                NewName: newName
            })
        }, function (data) {
            self.#WaitingPanel();
            self.#fillFolderContent(data);
        }, 'json');
    }

    zipSelectedItems = function () {
        let selectedItems = this.#checkIfAnyItemSelected();
        if (selectedItems === false) {
            return;
        }

        let zipFileName = selectedItems[0].split("\\").pop() + ".zip";
        if (selectedItems.length > 1) {
            zipFileName = prompt("@Model.Config.Language.ZipFileNameMessage", zipFileName);
            if (!zipFileName) {
                return;
            }
        }

        let self = this;
        this.#WaitingPanel();
        $.post(this.apiUrl, {
            id: this.thisId,
            command: "@Command.Zip",
            parameters: JSON.stringify({
                Path: this.getCurrentPath(),
                Items: selectedItems,
                FileName: zipFileName
            })
        }, function (data) {
            self.#WaitingPanel();
            self.#fillFolderContent(data);
        }, 'json');
    }

    extractSelectedItems = function () {
        let selectedItems = this.#checkIfAnyItemSelected();
        if (selectedItems === false) {
            return;
        }

        let self = this;
        this.#WaitingPanel();
        $.post(this.apiUrl, {
            id: this.thisId,
            command: "@Command.Unzip",
            parameters: JSON.stringify({
                Path: this.getCurrentPath(),
                Items: selectedItems
            })
        }, function (data) {
            self.#WaitingPanel();
            self.#fillFolderContent(data);
        }, 'json');
    }

    getFileContent = function () {
        let selectedItems = this.#checkIfAnyItemSelected('file');
        if (selectedItems === false) {
            return;
        }

        for (let i = 0; i < selectedItems.length; i++) {
            window.open(`${this.apiUrl}?id=${this.thisId}&command=@Command.GetFileContent&parameters=${selectedItems[i]}`, '_blank');
        }
    }

    downloadFile = function () {
        let selectedItems = this.#checkIfAnyItemSelected('file');
        if (selectedItems === false) {
            return;
        }

        for (let i = 0; i < selectedItems.length; i++) {
            window.open(`${this.apiUrl}?id=${this.thisId}&command=@Command.Download&parameters=${selectedItems[i]}`, '_blank');
        }
    }

    viewFile = function () {
        let selectedItems = this.#checkIfAnyItemSelected('file');
        if (selectedItems === false) {
            return;
        }

        for (let i = 0; i < selectedItems.length; i++) {
            window.open(`${this.apiUrl}?id=${this.thisId}&command=@Command.View&parameters=${selectedItems[i]}`, '_blank');
        }
    }

    goPreviousPath = function () {
        if (this.browseHistory.length > 0) {
            this.getFolderContent(this.browseHistory[this.browseHistory.length - 1], false);
            this.browseHistory = this.browseHistory.slice(0, -1);
            if (this.browseHistory.length == 0) {
                this.backButton.setAttribute('disabled', 'disabled');
            }
        }
    }

    copyItems = function () {
        if (!this.#checkIfAnyItemSelected()) return;

        this.clipboard = [];
        this.clipboard.push("copy");

        this.clipboard = this.clipboard.concat(this.getSelectedItemsPath());
        if (this.pasteButton)
            this.pasteButton.removeAttribute('disabled');

        console.log(this.contextMenu);
        let pasteContextMenu = this.contextMenu.items.filter(function (el) {
            return el && el.text.includes('@Model.Config.Language.Paste');
        });
        pasteContextMenu[0].disabled = false;
    }

    cutItems = function () {
        if (!this.#checkIfAnyItemSelected()) return;

        this.clipboard = [];
        this.clipboard.push("cut");

        this.clipboard = this.clipboard.concat(this.getSelectedItemsPath());
        if (this.pasteButton)
            this.pasteButton.removeAttribute('disabled');

        let pasteContextMenu = this.contextMenu.items.filter(function (el) {
            return el && el.text.includes('@Model.Config.Language.Paste');
        });
        pasteContextMenu[0].disabled = false;
    }

    pasteItems = function () {
        if (this.clipboard.length > 1) {

            let action = this.clipboard[0];
            this.clipboard.shift();

            //check if already exist
            let currentPath = this.getCurrentPath();
            let allItems = this.getAllItemsPath();
            if (allItems)
                for (let j = 0; j < this.clipboard.length; j++) {
                    let newName = this.clipboard[j].split("\\").pop();
                    let breakLoop = false;
                    for (let i = 0; i < allItems.length; i++) {
                        let element = allItems[i];
                        if (element.toLowerCase() === (currentPath + newName).toLowerCase()) {
                            if (confirm("@Model.Config.Language.OverrideConfirmationMessage")) {
                                breakLoop = true;
                                break;
                            } else {
                                this.clipboard = [action].concat(this.clipboard)
                                return;
                            }
                        }
                    }
                    if (breakLoop == true) break;
                }

            let self = this;
            this.#WaitingPanel();

            $.post(this.apiUrl, {
                id: this.thisId,
                command: action,
                parameters: JSON.stringify({
                    Path: this.getCurrentPath(),
                    Items: this.clipboard
                })
            }, function (data) {
                self.#WaitingPanel();
                self.#fillFolderContent(data);
            }, 'json');
        }
        this.clipboard = [];
        if (this.pasteButton)
            this.pasteButton.setAttribute('disabled', 'disabled');

        let pasteContextMenu = this.contextMenu.items.filter(function (el) {
            return el && el.text.includes('Paste');
        });
        pasteContextMenu[0].disabled = true;
    }

    toggleFilesListView = function () {
        if (this.jsSelectContinerDiv.classList.contains('list')) {
            this.jsSelectContinerDiv.classList.remove('list');
            Cookies.set('hgo-fm-current-view-' + this.thisId, '', {
                expires: 365
            });
        } else {
            this.jsSelectContinerDiv.classList.add('list');
            Cookies.set('hgo-fm-current-view-' + this.thisId, 'list', {
                expires: 365
            });
        }
    }

    showUploadPanel = function () {
        let uploadPanel = document.createElement('div');
        uploadPanel.classList.add('hgo-upload-panel', 'dropzone');

        let closeBtn = document.createElement('button');
        closeBtn.classList.add('close-button');
        closeBtn.innerText = '@Model.Config.Language.Close';
        uploadPanel.appendChild(closeBtn);
        closeBtn.addEventListener('click', (e) => {
            uploadPanel.remove();
            this.getFolderContent();
        });

        this.#fileManager().appendChild(uploadPanel);

        //init DropZone (Uploader)-------------------------------------
        Dropzone.autoDiscover = false;
        let dropZone = new Dropzone(uploadPanel, {
            url: this.apiUrl + `?id=${this.thisId}&command=@Command.Upload&parameters=${this.getCurrentPath()}`,
            parallelUploads: @Model.Config.ParallelUploads,
            chunking: @Model.Config.Chunking.ToString().ToLower(),
            chunkSize: @Model.Config.ChunkSizeByte, // bytes
            retryChunks: @Model.Config.RetryChunks.ToString().ToLower(),
            retryChunksLimit: @Model.Config.RetryChunksLimit,
            maxFilesize: @Model.Config.MaxFileSizeToUploadMByte, // mega bytes
            acceptedFiles: '@Model.Config.AcceptedFiles', //'.png,.pdf'
            paramName: 'file',

            dictDefaultMessage: "@Model.Config.Language.DictDefaultMessage",
            dictFallbackMessage: "@Model.Config.Language.DictFallbackMessage",
            dictFallbackText: "@Model.Config.Language.DictFallbackText",
            dictFileTooBig: "@Model.Config.Language.DictFileTooBig",
            dictInvalidFileType: "@Model.Config.Language.DictInvalidFileType",
            dictResponseError: "@Model.Config.Language.DictResponseError",
            dictCancelUpload: "@Model.Config.Language.DictCancelUpload",
            dictCancelUploadConfirmation: "@Model.Config.Language.DictCancelUploadConfirmation",
            dictRemoveFile: "@Model.Config.Language.DictRemoveFile",
            dictMaxFilesExceeded: "@Model.Config.Language.DictMaxFilesExceeded",
        });
    }
}



document.addEventListener('DOMContentLoaded', function () {
    // new HgoFileManager('@Model.Id', '@Model.ApiEndPoint', JSON.parse('Json.Serialize(@Model.Config)'));
    var instanceInterval = setInterval(() => {
        if (window.scriptsLoaded) {
            new HgoFileManager();
            clearInterval(instanceInterval);

            $("#loadingScripts").fadeOut("fast", function () {
                // setTimeout(()=>{
                $("#@Model.Id").fadeIn("fast");
                // },3000);
            });
        }
    }, 100);
}, false);
</script>
